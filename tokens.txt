2. TokenRepository (–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å + —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è)
Save(token string, userID uint, expiresAt time.Time)

Delete(token string)

DeleteAllByUserID(userID uint)

Find(token string) (*RefreshToken, error)

3. AuthService
–ú–µ—Ç–æ–¥—ã:

Login(email, password) ‚Üí –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–æ–∫–µ–Ω—ã, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç refresh.

Refresh(refreshToken) ‚Üí –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤ –ë–î, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –Ω–æ–≤—ã–π access.

Logout(refreshToken) ‚Üí —É–¥–∞–ª—è–µ—Ç refresh –∏–∑ –ë–î.

LogoutAll(userID) ‚Üí —É–¥–∞–ª—è–µ—Ç –≤—Å–µ refresh –ø–æ userID (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ).

4. JWTAuthMiddleware
–ü—Ä–æ–≤–µ—Ä—è–µ—Ç access token.

–ü—Ä–∏ –æ—à–∏–±–∫–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 401, –∞ –∫–ª–∏–µ–Ω—Ç —Å–∞–º —Ä–µ—à–∞–µ—Ç –¥–µ–ª–∞—Ç—å –ª–∏ refresh.

‚ùóÔ∏èMiddleware –Ω–µ –¥–µ–ª–∞–µ—Ç refresh –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, —ç—Ç–æ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ñ—Ä–æ–Ω—Ç–∞).



1. –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –º–µ—Ö–∞–Ω–∏–∑–º–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤
–°–æ–∑–¥–∞—Ç—å –º–µ—Ç–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤ (refresh_token)
–ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
2. –£–ª—É—á—à–µ–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Ç–æ–∫–µ–Ω–æ–≤
–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É IP-–∞–¥—Ä–µ—Å–∞ –≤ —Ç–æ–∫–µ–Ω—ã –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∫—Ä–∞–∂–∏
–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –º–µ—Ö–∞–Ω–∏–∑–º –æ—Ç–∑—ã–≤–∞ —Ç–æ–∫–µ–Ω–æ–≤ (blacklisting)
3. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤
–ù–∞—Å—Ç—Ä–æ–∏—Ç—å TTL (–≤—Ä–µ–º—è –∂–∏–∑–Ω–∏) –¥–ª—è —Ç–æ–∫–µ–Ω–æ–≤ –≤ Redis –∏–ª–∏ –¥—Ä—É–≥–æ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
–û—Ä–≥–∞–Ω–∏–∑–æ–≤–∞—Ç—å –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫—É—é –æ—á–∏—Å—Ç–∫—É –∏—Å—Ç–µ–∫—à–∏—Ö —Ç–æ–∫–µ–Ω–æ–≤

–ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è: –±–µ–∑–æ–ø–∞—Å–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ access + refresh —Å blacklisting
üí° –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:
Access Token: JWT, –∫–æ—Ä–æ—Ç–∫–æ–∂–∏–≤—É—â–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, 15 –º–∏–Ω), –Ω–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.

Refresh Token: –¥–ª–∏–Ω–Ω—ã–π (30 –¥–Ω–µ–π), —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ Redis —Å TTL.

Blacklist: Redis-—Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –æ—Ç–æ–∑–≤–∞–Ω–Ω—ã—Ö access —Ç–æ–∫–µ–Ω–æ–≤.

–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ: IP, user-agent, deviceID ‚Äî —Ö—Ä–∞–Ω–∏–º —Å refresh —Ç–æ–∫–µ–Ω–æ–º –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏.







üîê –ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è: –±–µ–∑–æ–ø–∞—Å–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ access + refresh —Å blacklisting
üí° –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:
Access Token: JWT, –∫–æ—Ä–æ—Ç–∫–æ–∂–∏–≤—É—â–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, 15 –º–∏–Ω), –Ω–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.

Refresh Token: –¥–ª–∏–Ω–Ω—ã–π (30 –¥–Ω–µ–π), —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ Redis —Å TTL.

Blacklist: Redis-—Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –æ—Ç–æ–∑–≤–∞–Ω–Ω—ã—Ö access —Ç–æ–∫–µ–Ω–æ–≤.

–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ: IP, user-agent, deviceID ‚Äî —Ö—Ä–∞–Ω–∏–º —Å refresh —Ç–æ–∫–µ–Ω–æ–º –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏.

üìå –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å:
1. –í—ã–¥–∞—á–∞ —Ç–æ–∫–µ–Ω–æ–≤ (Login / Register)
–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—à—å access_token –∏ refresh_token.

Access –≤–æ–∑–≤—Ä–∞—â–∞–µ—à—å –∫–ª–∏–µ–Ω—Ç—É.

Refresh —Å–æ—Ö—Ä–∞–Ω—è–µ—à—å –≤ Redis:

Key: "refresh:<user_id>:<token_id>"

Value: {ip, userAgent, expiresAt}

TTL = 30 –¥–Ω–µ–π

2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ (/refresh)
–ö–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç refresh_token.

–¢—ã:

–ü—Ä–æ–≤–µ—Ä—è–µ—à—å –µ–≥–æ –ø–æ–¥–ø–∏—Å—å.

–ü—Ä–æ–≤–µ—Ä—è–µ—à—å –Ω–∞–ª–∏—á–∏–µ –≤ Redis.

–ü—Ä–æ–≤–µ—Ä—è–µ—à—å IP / user-agent.

–£–¥–∞–ª—è–µ—à—å —Å—Ç–∞—Ä—ã–π refresh (—Ä–æ—Ç–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤).

–°–æ–∑–¥–∞—ë—à—å –Ω–æ–≤—ã–µ access + refresh —Ç–æ–∫–µ–Ω—ã.

–í–æ–∑–≤—Ä–∞—â–∞–µ—à—å –∏—Ö.

3. Logout
–£–¥–∞–ª—è–µ—à—å refresh —Ç–æ–∫–µ–Ω –∏–∑ Redis.

–î–æ–±–∞–≤–ª—è–µ—à—å access —Ç–æ–∫–µ–Ω –≤ Redis blacklist:

Key: "blacklist:<token_signature>"

TTL = access_token_expiration_time - now

4. Middleware –ø—Ä–æ–≤–µ—Ä–∫–∏ access —Ç–æ–∫–µ–Ω–∞
JWT –ø–∞—Ä—Å–∏—Ç—Å—è.

–ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –ø–æ–¥–ø–∏—Å—å, —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è.

–ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è: –Ω–µ—Ç –ª–∏ —Ç–æ–∫–µ–Ω–∞ –≤ Redis blacklist.

go
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
func JWTAuthMiddleware() gin.HandlerFunc {
	return func(c *gin.Context) {
		// 1. –ü–æ–ª—É—á–∏ access —Ç–æ–∫–µ–Ω –∏–∑ header
		// 2. –†–∞—Å–ø–∞—Ä—Å—å –µ–≥–æ, –ø—Ä–æ–≤–µ—Ä—å —Å—Ä–æ–∫, –ø–æ–¥–ø–∏—Å—å
		// 3. –ü—Ä–æ–≤–µ—Ä—å: –µ—Å—Ç—å –ª–∏ –≤ Redis "blacklist:<signature>"
		// 4. –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –ø—É—Å–∫–∞–µ–º –¥–∞–ª—å—à–µ, –∏–Ω–∞—á–µ ‚Äî 401
	}
}
5. –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ (–µ—Å–ª–∏ –±–µ–∑ Redis)
–ï—Å–ª–∏ –±—É–¥–µ—à—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å PostgreSQL:

refresh —Ç–æ–∫–µ–Ω—ã —Ö—Ä–∞–Ω–∏—à—å —Å –ø–æ–ª–µ–º expires_at

—Ñ–æ–Ω–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å —É–¥–∞–ª—è–µ—Ç —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ —Ä–∞–∑ –≤ –¥–µ–Ω—å.

üìã –ö–∞–∫ –µ—â—ë —É–ª—É—á—à–∏—Ç—å:
–£–ª—É—á—à–µ–Ω–∏–µ	–ß—Ç–æ –¥–∞—ë—Ç
–ü—Ä–∏–≤—è–∑–∫–∞ –∫ IP / User-Agent	–ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∫—Ä–∞–∂—É refresh —Ç–æ–∫–µ–Ω–∞
–û–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–µ refresh —Ç–æ–∫–µ–Ω—ã	–ü–æ–≤—ã—à–∞–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (—Ä–æ—Ç–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤)
Redis TTL	–ê–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤
Token ID (jti)	–ü–æ–∑–≤–æ–ª—è–µ—Ç –ª–µ–≥–∫–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –∏ –æ—Ç–∑—ã–≤–∞—Ç—å —Ç–æ–∫–µ–Ω—ã
–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞	–†–∞–∑–Ω—ã–µ –ø—Ä–∞–≤–∞ –¥–ª—è access (—á—Ç–µ–Ω–∏–µ) –∏ refresh (–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ)



1. üîê Middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ access_token
–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–ø–∏—Å—å, —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è.

–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –Ω–µ –≤ –±–ª–µ–∫–ª–∏—Å—Ç–µ –ª–∏ jti.

–ï—Å–ª–∏ –≤—Å—ë –æ–∫ ‚Äî –ø—É—Å–∫–∞–µ—Ç –¥–∞–ª—å—à–µ.

2. üîÅ Refresh —Ç–æ–∫–µ–Ω–∞
–ù–æ–≤—ã–π endpoint POST /refresh.

–ü—Ä–∏–Ω–∏–º–∞–µ—Ç refresh_token.

–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –µ–≥–æ –≤ Redis.

–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –Ω–æ–≤—ã–µ —Ç–æ–∫–µ–Ω—ã, —Å—Ç–∞—Ä—ã–π refresh —É–¥–∞–ª—è–µ—Ç, –Ω–æ–≤—ã–π —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç.

3. üö™ Logout
–î–æ–±–∞–≤–ª—è–µ—Ç access_token –≤ blacklist (–ø–æ jti).

–£–¥–∞–ª—è–µ—Ç refresh_token.